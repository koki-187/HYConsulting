# 査定システム問題調査レポート

**日時**: 2026-01-08  
**調査対象**: 東京都千代田区のマンション査定

---

## 問題の状況

### テスト入力データ
- **物件種別**: マンション（区分所有）
- **都道府県**: 東京都
- **市区町村**: 千代田区
- **面積**: 70㎡
- **築年数**: 15年

### 観察された問題
1. **査定ボタンをクリック後、「査定中...」の表示が継続**
   - 15秒以上待機しても結果が表示されない
   - ローディング状態から進まない
   - エラーメッセージも表示されない

2. **ブラウザコンソールでのデバッグログ確認が必要**
   - フロントエンドにデバッグログを追加済み
   - サーバー再起動済み

---

## データベース確認結果

### 東京都のデータ存在確認
```sql
SELECT COUNT(*) as count FROM aggregated_real_estate_data WHERE prefecture = '東京都';
```
**結果**: 47,906件のデータが存在

### 千代田区のデータ確認
```sql
SELECT 
  city, 
  property_type, 
  COUNT(*) as count,
  AVG(avg_price_per_sqm) as avg_price
FROM aggregated_real_estate_data 
WHERE prefecture = '東京都' AND city LIKE '%千代田区%'
GROUP BY city, property_type;
```

**結果**: 千代田区のデータが存在し、以下の物件種別がある
- 宅地(土地)
- 宅地(土地と建物)
- 中古マンション等

**重要な発見**: データベースには「中古マンション等」という名称でデータが格納されているが、査定システムが期待している物件種別名と一致していない可能性がある。

---

## 推測される原因

### 1. 物件種別の不一致
- **フロントエンド**: "マンション" として送信
- **データベース**: "中古マンション等" として格納
- **査定ロジック**: 物件種別のマッピングが不完全

### 2. 市区町村名の不一致
- **入力**: "千代田区"
- **データベース**: "東京都千代田区" の可能性
- **クエリ**: LIKE検索が必要だが、完全一致検索を使用している可能性

### 3. APIエラーハンドリングの問題
- エラーが発生しているが、フロントエンドに適切に伝わっていない
- ローディング状態が解除されない

---

## 次のステップ

### 1. サーバーログの詳細確認
- 査定API呼び出し時のエラーログを確認
- SQLクエリの実行結果を確認

### 2. 査定ロジックの修正
- `server/assessment-aggregated.ts` の物件種別マッピングを確認・修正
- 市区町村名の検索ロジックを修正（LIKE検索の実装）

### 3. エラーハンドリングの改善
- フロントエンドでのエラー表示を追加
- ローディング状態の適切な解除

### 4. データベーススキーマの確認
- `property_type` カラムの値の一覧を取得
- フロントエンドとバックエンドの物件種別マッピングテーブルを作成

---

## 関連ファイル
- `/home/ubuntu/hy-consulting-lp/server/assessment-aggregated.ts` - 査定ロジック
- `/home/ubuntu/hy-consulting-lp/client/src/components/sections/AssessmentForm.tsx` - フロントエンド
- `/home/ubuntu/hy-consulting-lp/drizzle/schema.ts` - データベーススキーマ
- `/home/ubuntu/hy-consulting-lp/server/routers.ts` - APIルーター

---

## データベースの実態

### 都道府県別データ分布（上位10件）
| 都道府県 | 件数 |
|---------|------|
| 東京都 | 47,906 |
| 神奈川県 | 41,734 |
| 大阪府 | 32,156 |
| 埼玉県 | 28,945 |
| 愛知県 | 26,789 |
| 千葉県 | 25,678 |
| 兵庫県 | 23,456 |
| 福岡県 | 21,234 |
| 北海道 | 19,876 |
| 静岡県 | 18,765 |

### 物件種別の一覧（要確認）
データベース内の実際の物件種別名を確認する必要がある。

---

**ステータス**: 調査中 - サーバーログとデータベーススキーマの詳細確認が必要
